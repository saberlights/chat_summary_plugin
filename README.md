# 聊天记录总结插件

## 功能介绍

这是一个用于分析群聊聊天记录并生成总结的插件。支持：

- ✅ 生成群聊整体的聊天记录总结
- ✅ 生成单个群员的聊天记录总结
- ✅ 支持今天和昨天的时间范围选择
- ✅ 使用AI智能分析聊天内容
- ✅ 符合机器人人设的语言风格
- ✅ 每日定时自动生成群聊总结
- ✅ **精美的图片输出** - 总结以美观的图片形式展示

## 安装和配置

1. 插件已位于 `plugins/chat_summary_plugin/` 目录
2. 编辑 `config.toml` 文件，将 `enabled` 设置为 `true` 来启用插件
3. 重启 MaiBot

## 使用方法

### 基本命令

```
/summary
```

生成今天整个群聊的总结

### 时间范围

```
/summary           # 今天的群聊总结
/summary 今天      # 今天的群聊总结
/summary 昨天      # 昨天的群聊总结
```

**注意：** 目前仅支持查询今天和昨天的聊天记录。

### 用户聊天总结

```
/summary @用户名           # 某个用户今天的聊天总结
/summary @用户名 昨天      # 某个用户昨天的聊天总结
/summary 123456789         # 通过QQ号查询今天的聊天总结
/summary 123456789 昨天    # 通过QQ号查询昨天的聊天总结
```

**注意：**
- 支持 QQ 的 @提及 功能（CQ码格式）
- 支持直接使用 `@昵称` 格式
- 支持直接输入 QQ 号查询
- 用户名可以是昵称或群名片的一部分

## 配置选项

在 `config.toml`中可以配置：

```toml
[plugin]
# 是否启用插件
enabled = true

[summary]
# 群聊总结的字数限制
group_summary_max_words = 400

# 单个用户总结的字数限制
user_summary_max_words = 300

# 是否启用单个用户的聊天总结
enable_user_summary = true

[auto_summary]
# 是否启用每日自动总结
enabled = false

# 每日自动总结的时间（HH:MM格式，24小时制）
time = "23:00"

# 生成总结所需的最少消息数量（低于此数量将不生成总结）
min_messages = 10

# 目标群聊QQ号列表（为空则对所有群聊生效）
# 示例: target_chats = [123456789, 987654321]
target_chats = []
```

### 自动总结功能

启用 `auto_summary.enabled = true` 后，插件会在每天指定时间自动为所有群聊生成今日总结：

- **精确定时**：采用计算等待时间的方式，而不是轮询检查，高效且准确
- **时区支持**：支持配置时区（如 Asia/Shanghai），需要安装 pytz 模块
- **智能过滤**：只为消息数达到最小要求的群聊生成总结
- **自动发送**：总结生成后自动发送到对应群聊
- **可自定义**：可以调整执行时间、时区和最小消息数量
- **指定群聊**：可以配置 `target_chats` 列表只为特定群聊生成总结

**注意：多个群聊会在同一时间点依次生成和发送总结，不是并发执行。**

#### 配置示例：

```toml
[auto_summary]
enabled = true
time = "23:00"
timezone = "Asia/Shanghai"
min_messages = 10
# 只为这两个群生成总结（留空则为所有群生成）
# 注意：填入实际的QQ群号（纯数字），不需要加引号
target_chats = [123456789, 987654321]
```

**配置说明**：
- `target_chats` 使用实际的 QQ 群号（数字格式）
- 插件会自动匹配数据库中的 `group_id` 字段
- 支持数字格式和字符串格式，推荐使用数字格式

#### 时区说明

插件支持配置时区来确保在正确的时间执行总结任务。常用时区：

- `Asia/Shanghai` - 中国标准时间（北京时间）
- `Asia/Hong_Kong` - 香港时间
- `Asia/Tokyo` - 日本标准时间
- `UTC` - 协调世界时
- `America/New_York` - 美国东部时间

**注意**：时区功能需要安装 `pytz` 模块：
```bash
pip install pytz
```

如果未安装 pytz 模块，插件会自动回退到使用系统时间。

## 示例输出

### 群聊总结示例

总结会以**精美的图片**形式输出，包含：
- 📊 大标题和可爱的图标
- 📈 消息数量和参与人数统计
- 💬 清晰易读的总结内容（大字体）
- 🎨 温暖的渐变背景和装饰元素
- 👥 可爱的小人装饰图案

图片示例（文字描述）：
```
顶部：💬 表情符号
标题：今天的群聊总结
副标题：2025-01-15
统计：📊 150 条消息  •  8 人参与

[白色卡片背景]
正文内容（大字体，清晰易读）：
今天群里挺热闹的呀～早上大家在讨论新出的游戏，小明一直在
安利他玩的那个RPG，说剧情超好。中午的时候小红开始吐槽公司
的项目又延期了，大家都在安慰她哈哈。下午聊到了晚饭吃什么，
最后约好了一起去吃火锅！晚上主要在水群发表情包，氛围很欢乐～
[/白色卡片背景]

底部：两个可爱的小人装饰
背景：温暖的米色渐变 + 彩色圆形装饰
```

**注意：** 实际输出会根据机器人的人设和回复风格生成，保持个性化的语言特色。如果图片生成失败，会自动降级为文本输出。

### 用户总结示例

用户总结也会以图片形式输出，格式类似群聊总结，但标题会显示用户信息。

## 图片输出特性

### 视觉设计
- **温暖配色**：米白色到淡粉色的渐变背景，给人温馨舒适的感觉
- **大字号**：正文使用 36px 字体，确保在手机上也清晰易读
- **卡片式布局**：白色半透明卡片，带阴影和圆角，现代美观
- **装饰元素**：
  - 四角的彩色半透明圆形装饰
  - 底部的可爱小人图案（简笔画风格）
  - 顶部的大emoji图标

### 自动降级
如果图片生成失败（例如字体缺失），插件会自动降级为纯文本输出，确保总结功能始终可用。

## 技术实现

- 使用 `BaseCommand` 实现命令处理
- 使用 `BaseEventHandler` 实现启动事件监听
- 使用独立的 `SummaryScheduler` 类管理定时任务，代码结构清晰
- 采用精确计算等待时间的调度方式，避免轮询检查，显著降低资源消耗
- 通过 `database_api` 从 `Messages` 表读取聊天记录
- 使用 `chat_info_group_id` 字段匹配实际的QQ群号，而非哈希的 chat_id
- 使用 `llm_api` 调用主回复模型（replyer）生成智能总结
- 注入机器人的 `personality` 确保总结符合人设
- 支持 QQ CQ 码格式的 @提及 解析
- 支持时区配置（pytz），自动回退到系统时间
- 使用 `send_api.text_to_stream()` 发送消息，参数 `storage_message=False` 避免存储系统消息
- **图片生成**：使用 PIL (Pillow) 生成精美的总结图片
  - 自定义字体大小和颜色
  - 渐变背景和装饰图案
  - 可爱的小人简笔画
  - 自动换行和文本排版
  - 失败时自动降级为文本输出

## 注意事项

1. 总结生成需要调用 AI 模型，可能需要几秒钟时间
2. 只统计普通聊天消息，不包括命令和系统通知
3. 用户名匹配支持：
   - QQ CQ 码格式：`[CQ:at,qq=123456]`
   - 文本 @ 格式：`@昵称`
   - 直接输入 QQ 号：`123456789`
   - 模糊匹配昵称或群名片
4. 生成的总结会根据配置的字数限制自动控制长度
5. 仅支持查询今天和昨天的聊天记录
6. 自动总结功能：
   - 需要手动在配置文件中启用
   - 采用精确计算等待时间的方式，不再轮询检查
   - 支持时区配置（需要安装 pytz 模块）
   - 每天只在指定时间执行一次
   - 只为达到最小消息数量的群聊生成总结
   - 总结会以图片形式自动发送
   - 可通过 `target_chats` 配置只为指定群聊生成总结
   - 多个群聊会依次生成，不是并发（避免 API 限流）
   - 启动时会显示下次执行时间和等待时长
7. **图片生成要求**：
   - 需要安装 Pillow 库：`pip install Pillow`
   - 需要系统中有中文字体（通常Linux和Windows系统都已包含）
   - 如果图片生成失败会自动降级为文本输出

## 开发信息

- 插件版本: 1.0.0
- 依赖: Pillow (图片生成)
- 作者: MaiBot Team

## 自定义美化

如果你想自定义图片的样式，可以编辑 `summary_image_generator.py` 文件中的配置：

### 修改颜色
```python
# 背景颜色（RGB格式）
BG_START_COLOR = (255, 250, 245)  # 起始颜色
BG_END_COLOR = (255, 240, 235)    # 结束颜色

# 装饰颜色
ACCENT_COLOR_1 = (255, 182, 193)  # 淡粉色
ACCENT_COLOR_2 = (173, 216, 230)  # 淡蓝色

# 文字颜色
TITLE_COLOR = (80, 80, 100)       # 标题
TEXT_COLOR = (60, 60, 80)         # 正文
```

### 修改字体大小
```python
TITLE_SIZE = 56      # 标题
TEXT_SIZE = 36       # 正文（建议不小于32，确保手机可读）
EMOJI_SIZE = 80      # Emoji大小
```

### 修改图片尺寸
```python
DEFAULT_WIDTH = 1600  # 图片宽度（像素）
```

### 添加更多装饰
你可以修改 `_draw_decorative_circles()` 方法来添加更多装饰元素，或者修改 `_draw_cute_character()` 来改变小人的样式。
